---
title: "Problem Set 3"
author: "Alex, Micah, Scott, and David"
date: "12/01/2021"
name: Tina Fang
output: 
  pdf_document: 
    number_sections: true
header-includes:
   - \usepackage{dcolumn}    
classoption: landscape
#output: github_document
---


```{r global options, include = FALSE}
knitr::opts_chunk$set(include = FALSE, message = FALSE, warning = FALSE)

knitr::knit_engines$set(problem_description = function(options) {
  code <- paste(options$code, collapse = "\n")
})
```

$5$

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(stargazer)
```

Here is the latex table in a PDF document:

```{r mylatextable, include=TRUE, results = "asis"}
stargazer(attitude, header=FALSE, type = 'latex')
```

```{r}
# tinytex::install_tinytex()
# install.packages("stargazer")
```

```{r}
library(data.table)
library(sandwich)
library(lmtest)

library(ggplot2)
library(knitr)
library(foreign)
library(stargazer)
```

```{r, include=FALSE}
d <- read.csv(file = 'data/input/ESG Survey 3_April 8, 2022_10.20.csv')
d <- data.table(d)
colnames(d)
```


```{r}
columns_to_analyse <- c('StartDate', 'EndDate', 'Duration..in.seconds.', 'Q18', 'Gender', 'Investing.knowledge','Age', 'Education', 'Household.income', 'Ethnicity', 'Stock_1', 'Q22', 'Gender.1', 'Investing.knowledge.1', 'Age.1', 'Education.1', 'Household.income.1', 'Ethnicity.1', 'Stock_1.1')
columns_temp <- c("StartDate", "EndDate", "Q18")

# colnames(d)

subset(d, select = columns_to_analyse)
nrows <- nrow(d)
# remove the metadata

d <- d[3:nrows,]
d <- d[d$StartDate >= "2022-04-06 14:33:20"]
d
```
There are `r nrows` in this analysis.

```{r}
hist(as.numeric(d$Duration..in.seconds))
```

### Covariate balance checks



```{r, include=TRUE}
d$assignment_to_treatment <-  ifelse(d$Gender.1 == "", 0, 1)
d$gender <- ifelse(d$assignment_to_treatment == 1, 
                              d$Gender.1, d$Gender)
d$investing_knowledge <- ifelse(d$assignment_to_treatment == 1, 
                                           d$Investing.knowledge.1, d$Investing.knowledge)
d$age <- ifelse(d$assignment_to_treatment == 1, 
                           d$Age.1, d$Age)
d$education <- ifelse(d$assignment_to_treatment == 1, 
                           d$Education.1, d$Education)
d$household_income <- ifelse(d$assignment_to_treatment == 1, 
                           d$Household.income.1, d$Household.income)
d$ethnicity <- ifelse(d$assignment_to_treatment == 1, 
                           d$Ethnicity.1, d$Ethnicity)
d$stock <- ifelse(d$assignment_to_treatment == 1, 
                           d$Stock_1.1, d$Stock_1)
d$assignment_to_treatment_name <- ifelse(d$assignment_to_treatment == 1, "Treatment", "Control")

d[d$gender == ""]$gender <- "No Data"
d[d$investing_knowledge == ""]$investing_knowledge <- "No Data"
d[d$age == ""]$age <- "No Data"
d[d$education == ""]$education <- "No Data"
d[d$household_income == ""]$household_income <- "No Data"
d[d$ethnicity == ""]$ethnicity <- "No Data"
d[d$stock == ""]$stock <- "No Data"
```

```{r}
attach(d)
plot(as.numeric(d$Duration..in.seconds), stock, main="Scatterplot Example",
   xlab="time", ylab="conf", pch=19) 
sum(d$assignment_to_treatment)
```

### Covariate Balance Checks

```{r, include=TRUE}
# Gender
ggplot(d, aes(x = assignment_to_treatment_name, fill = gender)) +
  geom_bar() +
  ylab("Number of Participants") +
  xlab("Assignment") +
  ggtitle("Gender Count by Assignment") +
  labs(fill = "Gender")
  scale_x_discrete(
   "Assignment to Treatment",
   labels=c("Control", "Treatment"),
   limits=factor(0, 1))

# Investing Knowledge
ggplot(d, aes(x = assignment_to_treatment, fill = investing_knowledge)) +
  geom_bar() +
  ylab("Number of Participants") +
  xlab("Assignment") +
  ggtitle("Investing Knowledge Count by Assignment") +
  labs(fill = "Investing Knowledge")
  scale_x_discrete(
   "Assignment to Treatment",
   labels=c("Control", "Treatment"),
   limits=factor(0, 1))

# Age
ggplot(d, aes(x = assignment_to_treatment, fill = age)) +
  geom_bar()

# Education
ggplot(d, aes(x = assignment_to_treatment, fill = education)) +
  geom_bar()

# Household Income
ggplot(d, aes(x = assignment_to_treatment, fill = household_income)) +
  geom_bar()

# Ethnicity
ggplot(d, aes(x = assignment_to_treatment, fill = ethnicity)) +
  geom_bar()
```
It looks pretty balanced.

```{r}
# To check quantitatively, use F-test 

null_mod <- d[ , lm(assignment_to_treatment ~ 1)]
# gender, investing knowledge, age, education, ethnicity
full_mod <- d[ , lm(assignment_to_treatment ~ 1 + I(gender) + I(investing_knowledge) + I(age) + I(education) + I(ethnicity))]
anova_mod <- anova(full_mod, null_mod, test = 'F')
anova_mod
```
The p-value is greater than 0.05, and we do not reject the null hypothesis that each of the differences between treatment and control are 0.

```{r}
d[(d$age == "No Data") | (d$education == "No Data") | (d$household_income == "No Data") | (d$ethnicity == "No Data") | (d$stock == "No Data") | (d$investing_knowledge == "No Data")]
```

```{r}
# Represent it

ggplot(d, aes(x=as.numeric(stock), fill=as.factor(assignment_to_treatment))) +
  geom_density( color="#e9ecef", alpha=0.2, position = 'identity') +
  scale_fill_manual(values=c("green", "red")) +
  labs(fill="Assignment to Treatment") +
  xlab("Likelihood to Invest in Presented Company") + 
  ylab("Number of Participants") +
  ggtitle("Comparison of Distributions of Outcome")
```

### Average Treatment Effect Estimate

```{r}
control <- as.numeric(d[d$assignment_to_treatment == 0]$stock)
treatment <- as.numeric(d[d$assignment_to_treatment == 1]$stock)

treatment_mean <- mean(treatment)
control_mean <- mean(na.omit(control))

ate <- (treatment_mean - control_mean) / control_mean



t.test(control, treatment)
```

```{r}
d$duration <- as.numeric(d$Duration..in.seconds)

length(d[d$duration <= 60])

d[(d$duration <= 60) & (d$investing_knowledge == "0-1 year")]$assignment_to_treatment

length(d[(d$duration <= 60) & (d$investing_knowledge == "0-1 year")]$assignment_to_treatment)

sum(d[(d$duration <= 60) & (d$investing_knowledge == "0-1 year")]$assignment_to_treatment)

sum(d[d$duration <= 60]$assignment_to_treatment)

d[d$duration <= 30]$assignment_to_treatment

d
```
There is a 6% decrease in the likelihood of investing in a stock given the low ESG score (3.8/10) in the treatment.

```{r}
library(sandwich)
library(lmtest)

model_2 <- lm(as.numeric(
  stock) ~ assignment_to_treatment + 
    I(household_income) +
    I(gender) +
    I(age) +
    I(ethnicity) +
    I(investing_knowledge) + 
    I(education),
            data=d)
coef_se <- lmtest::coefci(model_2, vcov.=vcovHC(model_2, type="HC"))
model_summary_2 <- summary(model_2, se=coef_se)
model_summary_2
```


```{r}
model <- lm(as.numeric(
  stock) ~ assignment_to_treatment,
            data=d)
coef_se <- lmtest::coefci(model, vcov.=vcovHC(model, type="HC"))
model_summary <- summary(model, se=coef_se)
model_summary
```

```{r}
get_power <- function(mean1, mean2, N, sigma, alpha) {
  part1 <- (abs(mean1-mean2) * sqrt(N))/(2*sigma)
  part2 <- qnorm(1 - alpha/2)
  beta <- pnorm(part1 - part2)
  return(beta)
}
```

```{r}
get_power(60,65,500,20,0.05)

get_power(60,65,500,20,0.05)

get_power(mean1=60, mean2=65, N=500, sigma=20, alpha=0.05)

get_power(mean1=53.7, mean2=46.6, N=414, sigma=25.9, alpha=0.05)
```

```{r}
get_sample_size <- function(mean1, mean2, beta, sigma, alpha) {
  part1 <- qnorm(beta)
  part2 <- qnorm(1 - alpha/2)
  ((part1 + part2) * (2*sigma) / abs(mean1-mean2)) ^ 2
}
```

# $$\beta = \Phi(|\mu_t-\mu_c|)$$
# $$\sqrt{x}$$

# $$\beta = \Phi\Big(\frac{|\mu_t-\mu_c|\sqrt{N}}{2\sigma} - \Phi^{-1}(1-\frac{\alpha}{2})\Big)$$
# $$N = \Bigg(\frac{\Big(\Phi^{-1}(\beta) + \Phi^{-1}(1-\frac{\alpha}{2})\Big) 2\sigma}{|\mu_t-\mu_c|}\Bigg) ^ 2$$
```{r}
get_sample_size <- function(mean1, mean2, beta, sigma, alpha) {
  part1 <- qnorm(beta)
  part2 <- qnorm(1 - alpha/2)
  ((part1 + part2) * (2*sigma) / abs(mean1-mean2)) ^ 2
}
```

```{r}
pnorm(0.4) # normsdist

qnorm(0.95) # normsinv


pnorm(qnorm(0.95))

# Pilot data information
mean1 <-53.714285714285715
mean2 <- 46.57142857142857
beta <- 0.8
sigma <- 25.909692574636413
alpha <- 0.05

get_sample_size(mean1=mean1, mean2=mean2, beta=beta, sigma=sigma, alpha=alpha)
get_power(mean1=mean1, mean2=mean2, N=454, sigma=sigma, alpha=alpha)
```

```{r}
t.test(control, treatment)
```

```{r model_summary, include=TRUE, results = "asis"}
stargazer(model, model_2, title="Results", align=TRUE)
```


